{% extends "base.html.j2" %}
{% import "macros/chat_card.html.j2" as cards %}

{% block title %}
{% if chat %}
{{ chat.name }} - Topics
{% else %}
Forum Topics
{% endif %}
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="/static/css/chat_list.css?t={{ 'static/css/chat_list.css' | file_mtime }}">
<link rel="stylesheet" href="/static/css/forum_styles.css?t={{ 'static/css/forum_styles.css' | file_mtime }}">
{% endblock %}

{% block sidebar_back %}
<a href="/" class="back-link">← Back to Chats</a>
{% endblock %}

{% block sidebar_info %}
{% if chat %}
<div style="text-align: center; margin-bottom: 20px;">
    {% if chat.image_url %}
    <img src="{{ chat.image_url }}"
        style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;">
    {% else %}
    <div
        style="width: 80px; height: 80px; border-radius: 50%; background: #e0f7fa; color: #006064; margin: 0 auto 10px auto; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
        {{ chat.name[0] | upper }}
    </div>
    {% endif %}
    <h3 style="margin: 0; font-size: 1.1rem;">{{ chat.name }}</h3>
    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">Forum</p>
</div>
{% endif %}
{% endblock %}

{% block settings %}
<div class="setting-option" id="btn-read-forum" style="color: #2e7d32; font-weight: 500;">
    ✅ Read All Topics
</div>
<script>
    document.getElementById('btn-read-forum').addEventListener('click', async () => {
        const btn = document.getElementById('btn-read-forum');
        btn.style.opacity = '0.5';
        btn.style.pointerEvents = 'none';

        try {
            const url = `/api/chat/{{ chat.id }}/read`;
            await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
        } catch (e) {
            console.error(e);
        } finally {
            setTimeout(() => {
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            }, 500);
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="header">
    <h1>
        {% if chat %}
        {{ chat.name }} <span style="font-weight: normal; font-size: 0.8em; color: #666;">(Topics)</span>
        {% else %}
        Topics
        {% endif %}
    </h1>
</div>

<div class="chat-list">
    {% for topic in chats %}
    {{ cards.render_chat_card(topic, parent_id=chat.id) }}
    {% endfor %}
</div>
{% endblock %}
