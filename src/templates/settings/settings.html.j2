{% extends "base.html.j2" %}

{% block title %}Settings{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="/static/css/settings.css?t={{ 'static/css/settings.css' | file_mtime }}">
{% endblock %}

{% block sidebar_back %}
<a href="/" class="back-link">‚Üê Back to Chats</a>
{% endblock %}

{% block content %}

<div class="settings-container">

    <!-- 1. Global Settings (Grid, No Header) -->
    <div class="section-card">

        <div class="gs-grid">
            <!-- Toggle Card: Service Messages -->
            <label class="gs-card toggle-card" onclick="toggleSetting('autoread_service_messages')">
                <input type="checkbox" id="t-service" {% if settings.autoread_service_messages %}checked{% endif %}>
                <div class="gs-content">
                    <span class="gs-label">Service Messages</span>
                    <span class="gs-status-badge"></span>
                </div>
            </label>

            <!-- Toggle Card: Polls -->
            <label class="gs-card toggle-card" onclick="toggleSetting('autoread_polls')">
                <input type="checkbox" id="t-polls" {% if settings.autoread_polls %}checked{% endif %}>
                <div class="gs-content">
                    <span class="gs-label">Polls</span>
                    <span class="gs-status-badge"></span>
                </div>
            </label>

            <!-- Toggle Card: Self -->
            <label class="gs-card toggle-card" onclick="toggleSetting('autoread_self')">
                <input type="checkbox" id="t-self" {% if settings.autoread_self %}checked{% endif %}>
                <div class="gs-content">
                    <span class="gs-label">My Messages</span>
                    <span class="gs-status-badge"></span>
                </div>
            </label>

            <!-- Toggle Card: Debug Mode -->
            <label class="gs-card toggle-card" onclick="toggleSetting('debug_mode')">
                <input type="checkbox" id="t-debug" {% if settings.debug_mode %}checked{% endif %}>
                <div class="gs-content">
                    <span class="gs-label" style="color: #6ab7ff;">Debug Mode</span>
                    <span class="gs-status-badge"></span>
                </div>
            </label>
        </div>

        <!-- Expanded Inputs (Grid Row 2) -->
        <div class="gs-expanded-row">
            <!-- Autoread Users Card -->
            <div class="gs-display-card {{ 'has-content' if settings.autoread_bots else '' }}">
                <div class="gs-display-header">
                    <span>Autoread Users</span>
                    <button class="edit-icon-btn" onclick="openModal('modal-bots')">‚úèÔ∏è Edit</button>
                </div>
                <div class="gs-display-content">
                    {% if settings.autoread_bots %}
                    <div class="bot-tags">
                        {% for bot in settings.autoread_bots.split(',') %}
                        {% if bot.strip() %}
                        <span class="bot-tag">{{ bot.strip() }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <span class="gs-none">None configured</span>
                    {% endif %}
                </div>
            </div>

            <!-- Autoread Regex Card -->
            <div class="gs-display-card {{ 'has-content' if settings.autoread_regex else '' }}">
                <div class="gs-display-header">
                    <span>Autoread Regex</span>
                    <button class="edit-icon-btn" onclick="openModal('modal-regex')">‚úèÔ∏è Edit</button>
                </div>
                <div class="gs-display-content">
                    {% if settings.autoread_regex %}
                    <code class="regex-block">{{ settings.autoread_regex }}</code>
                    {% else %}
                    <span class="gs-none">None configured</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Active Rules Summary (No Header, Full Width) -->
    <div class="section-card">
        {% if grouped_rules %}
        {% for chat_id, data in grouped_rules.items() %}
        <div class="rule-group-card" data-chat-id="{{ chat_id }}">
            <a href="/chat/{{ chat_id }}" class="rg-header" title="Open Chat">
                <div class="rg-avatar">?</div>
                <div class="rg-info">
                    <div class="rg-name">Chat ID: {{ chat_id }}</div>
                    <div class="rg-type rg-loading">Loading info...</div>
                </div>
                <div style="font-size: 0.8rem; color: #555;">ID: {{ chat_id }}</div>
            </a>

            {% if data.chat_rules %}
            <div class="rule-list">
                {% for rule in data.chat_rules %}
                <div class="rule-item">
                    <span class="rule-type-badge badge-{{ rule.rule_type.value }}">{{ rule.rule_type.value }}</span>
                    <div class="rule-detail">
                        {% if rule.rule_type.value == 'autoreact' %}
                        <div class="ar-display">
                            <div class="ar-emoji">{{ rule.config.emoji or 'üí©' }}</div>
                            <div class="ar-targets">
                                {% if rule.config.target_users %}
                                {% for uid in rule.config.target_users %}
                                <div class="user-chip-lazy" data-user-id="{{ uid }}">
                                    <div class="u-avatar">?</div>
                                    <span class="u-name">{{ uid }}</span>
                                </div>
                                {% endfor %}
                                {% else %}
                                <span class="ar-default">Default (Channel/Main)</span>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        {% if rule.config %}
                        <span class="rule-config">{{ rule.config }}</span>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if data.topics %}
            <div class="rule-list" style="padding-top: 0;">
                {% for topic_id, t_rules in data.topics.items() %}
                <div class="topic-group">
                    <div class="topic-header">
                        <span style="margin-right: 5px;">#</span> Topic ID: {{ topic_id }}
                    </div>
                    {% for rule in t_rules %}
                    <div class="rule-item">
                        <span class="rule-type-badge badge-{{ rule.rule_type.value }}">{{ rule.rule_type.value }}</span>
                        <div class="rule-detail">
                            {% if rule.rule_type.value == 'autoreact' %}
                            <div class="ar-display">
                                <div class="ar-emoji">{{ rule.config.emoji or 'üí©' }}</div>
                                <div class="ar-targets">
                                    {% if rule.config.target_users %}
                                    {% for uid in rule.config.target_users %}
                                    <div class="user-chip-lazy" data-user-id="{{ uid }}">
                                        <div class="u-avatar">?</div>
                                        <span class="u-name">{{ uid }}</span>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <span class="ar-default">Default (Channel/Main)</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            {% if rule.config %}
                            <span class="rule-config">{{ rule.config }}</span>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <div style="text-align: center; color: #777; padding: 30px;">
            No specific rules configured.
        </div>
        {% endif %}
    </div>

    <!-- Danger Zone Footer (Only in Debug Mode) -->
    {% if settings.debug_mode %}
    <div class="danger-zone">
        <button type="button" class="reset-btn" id="reset-btn">Reset everything</button>
    </div>
    {% endif %}

</div>

<!-- MODALS -->
<!-- 1. Bots Modal -->
<div id="modal-bots" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Autoread Users</h3>
            <span class="modal-close" onclick="closeModal('modal-bots')">&times;</span>
        </div>
        <div class="modal-body">
            <textarea id="input-bots"
                style="width:100%; height:100px; background:#2a2a2c; border:1px solid #444; color:#fff; border-radius:4px; padding:10px; font-family:monospace;"
                placeholder="@BotFather, @OtherBot">{{ settings.autoread_bots }}</textarea>
            <div class="help-text">Comma separated list of usernames.</div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modal-bots')">Cancel</button>
            <button class="btn-save" onclick="saveField('autoread_bots', 'input-bots')">Save</button>
        </div>
    </div>
</div>

<!-- 2. Regex Modal -->
<div id="modal-regex" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Autoread Regex</h3>
            <span class="modal-close" onclick="closeModal('modal-regex')">&times;</span>
        </div>
        <div class="modal-body">
            <input type="text" id="input-regex"
                style="width:100%; background:#2a2a2c; border:1px solid #444; color:#fff; border-radius:4px; padding:10px; font-family:monospace;"
                value="{{ settings.autoread_regex }}" placeholder="(crypto|buy|sell)">
            <div class="help-text">Regular expression to match against message text.</div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modal-regex')">Cancel</button>
            <button class="btn-save" onclick="saveField('autoread_regex', 'input-regex')">Save</button>
        </div>
    </div>
</div>

<script>
    // --- API Helper ---
    async function patchSetting(payload) {
        try {
            const res = await fetch('/api/settings', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                window.location.reload();
            } else {
                alert("Failed to save setting");
            }
        } catch (e) {
            console.error(e);
            alert("Network Error");
        }
    }

    // --- Toggle Logic ---
    function toggleSetting(key) {
        // Handle mapped keys for IDs
        let idMap = {
            'autoread_service_messages': 't-service',
            'autoread_polls': 't-polls',
            'autoread_self': 't-self',
            'debug_mode': 't-debug'
        };
        let elId = idMap[key] || key;
        const checkbox = document.getElementById(elId);

        setTimeout(() => {
            const val = checkbox.checked;
            const payload = {};
            payload[key] = val;
            patchSetting(payload);
        }, 50);
    }

    // --- Modal Logic ---
    function openModal(id) {
        document.getElementById(id).classList.add('show');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }

    function saveField(key, inputId) {
        const val = document.getElementById(inputId).value;
        const payload = {};
        payload[key] = val;
        patchSetting(payload);
    }

    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.classList.remove('show');
            }
        });
    });

    // --- Reset Logic ---
    const resetBtn = document.getElementById('reset-btn');
    if (resetBtn) {
        resetBtn.addEventListener('click', async () => {
            if (!confirm("Are you sure? This will delete your account and all associated rules from this manager.")) {
                return;
            }
            resetBtn.textContent = "Resetting...";
            resetBtn.disabled = true;

            try {
                const res = await fetch('/api/settings/reset', { method: 'POST' });
                if (res.ok) {
                    window.location.href = '/login';
                } else {
                    alert("Failed to reset account.");
                    resetBtn.textContent = "Reset everything";
                    resetBtn.disabled = false;
                }
            } catch (err) {
                alert("Network Error");
                resetBtn.textContent = "Reset everything";
                resetBtn.disabled = false;
            }
        });
    }

    // --- Active Rules List Lazy Loading ---
    document.addEventListener('DOMContentLoaded', async () => {
        const cards = document.querySelectorAll('.rule-group-card');
        cards.forEach(async (card) => {
            const chatId = card.getAttribute('data-chat-id');
            if (!chatId) return;

            try {
                const res = await fetch(`/api/chat/${chatId}/info`);
                if (res.ok) {
                    const data = await res.json();
                    const nameEl = card.querySelector('.rg-name');
                    const typeEl = card.querySelector('.rg-type');
                    const avatarEl = card.querySelector('.rg-avatar');

                    nameEl.textContent = data.name;
                    typeEl.textContent = data.type;
                    typeEl.classList.remove('rg-loading');

                    if (data.avatar_url) {
                        avatarEl.innerHTML = `<img src="${data.avatar_url}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                    } else {
                        avatarEl.textContent = data.name.charAt(0).toUpperCase();
                    }
                } else {
                    card.querySelector('.rg-type').textContent = "Info unavailable";
                }
            } catch (e) {
                console.error("Failed to load info for chat", chatId, e);
            }
        });

        const userChips = document.querySelectorAll('.user-chip-lazy');
        userChips.forEach(async (chip) => {
            const uid = chip.getAttribute('data-user-id');
            if (!uid) return;
            try {
                const res = await fetch(`/api/chat/${uid}/info`);
                if (res.ok) {
                    const data = await res.json();
                    const avatarEl = chip.querySelector('.u-avatar');
                    const nameEl = chip.querySelector('.u-name');
                    nameEl.textContent = data.name;
                    if (data.avatar_url) {
                        avatarEl.innerHTML = `<img src="${data.avatar_url}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                    } else {
                        avatarEl.textContent = data.name.charAt(0).toUpperCase();
                    }
                    chip.title = `@${data.username || 'unknown'}`;
                }
            } catch (e) { }
        });
    });
</script>
{% endblock %}
