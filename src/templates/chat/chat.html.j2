{% extends "base.html.j2" %}

{% block title %}
{% if chat %}
{{ chat.name }}
{% else %}
Messages
{% endif %}
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="/static/css/chat_styles.css?t={{ 'static/css/chat_styles.css' | file_mtime }}">
{% endblock %}

{% block sidebar_back %}
{% if topic_id %}
<a href="/forum/{{ chat_id }}" class="back-link">‚Üê Back to Topics</a>
{% else %}
<a href="/" class="back-link">‚Üê Back to Chats</a>
{% endif %}
{% endblock %}

{% block sidebar_info %}
{% if chat %}
<div style="text-align: center; margin-bottom: 20px;">
    {% if chat.image_url %}
    <img src="{{ chat.image_url }}"
        style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;">
    {% else %}
    <div
        style="width: 80px; height: 80px; border-radius: 50%; background: #333; margin: 0 auto 10px auto; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #aaa;">
        {{ chat.name[0] | upper }}
    </div>
    {% endif %}
    <h3 style="margin: 0; font-size: 1.1rem;">{{ chat.name }}</h3>
    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">{{ chat.type.value | title }}</p>
</div>
{% endif %}
{% endblock %}

{% block settings %}
<div class="setting-option">
    <label style="display: flex; align-items: center; cursor: pointer; font-weight: 500;">
        <input type="checkbox" id="autoread-checkbox" {% if autoread_enabled %}checked{% endif %}>
        <span style="margin-left: 8px;">Autoread messages</span>
    </label>
</div>

<!-- Autoreact Section -->
<div class="ar-container">
    <div class="ar-header" onclick="toggleArBody()">
        <span>‚ö° Autoreact</span>
        <span id="ar-toggle-icon">‚ñº</span>
    </div>
    <div class="ar-body" id="ar-body">
        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
            <input type="checkbox" id="autoreact-checkbox">
            <span style="margin-left: 8px;">Enable Autoreact</span>
        </label>

        <div style="margin-bottom: 5px; color: #888;">Reaction:</div>
        <div class="emoji-selector" id="emoji-selector">
            <div class="emoji-opt selected" data-emoji="üí©">üí©</div>
            <div class="emoji-opt" data-emoji="ü§°">ü§°</div>
            <div class="emoji-opt" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
            <input type="text" id="custom-emoji-input" placeholder="Custom"
                style="width: 50px; background: #2a2a2c; border: 1px solid #444; color: #fff; border-radius: 4px; padding: 5px; text-align: center;">
        </div>

        <div style="margin-bottom: 5px; color: #888;">React to Users:</div>
        <div class="user-selector-wrapper">
            <div class="user-selector-display" id="user-display"
                onclick="event.stopPropagation(); toggleUserDropdown()">
                <span style="color: #666; font-style: italic;">Loading...</span>
            </div>
            <div class="user-dropdown" id="user-dropdown">
                <div style="padding: 10px; color: #aaa; font-style: italic;">Loading users...</div>
            </div>
        </div>
        <div style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">
            Empty = Default (Channel / Main)
        </div>

        <button id="save-ar-btn"
            style="width: 100%; padding: 6px; background: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
    </div>
</div>

{% if topic_id %}
<div class="setting-option" id="apply-all-topics"
    style="margin-top: 12px; color: #ff9800; font-weight: 500; cursor: pointer; display: flex; align-items: center; padding: 5px 0;">
    <span style="margin-right: 6px;">üìã</span> Copy Autoread to all
</div>
{% endif %}

<div class="setting-option" id="btn-read-chat"
    style="margin-top: 20px; color: #2e7d32; font-weight: 500; cursor: pointer;">
    ‚úÖ Mark as Read
</div>

<!-- Toast Container -->
<div id="toast"></div>

<script>
    const chatId = {{ chat_id }};
    const topicId = {{ topic_id or 'null' }};
    const isPremium = {{ 'true' if is_premium else 'false' }};

    let arConfig = {
        enabled: false,
        emoji: 'üí©',
        target_users: []
    };
    let availableUsers = [];

    // --- Toast Logic ---
    function showToast(message) {
        const x = document.getElementById("toast");
        x.textContent = message;
        x.className = "show";
        setTimeout(function () { x.className = x.className.replace("show", ""); }, 5000);
    }

    // --- Debug Process ---
    async function debugProcessMessage(el, msgId) {
        el.style.opacity = '0.5';
        try {
            const res = await fetch('/api/debug/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: chatId, msg_id: msgId })
            });
            const data = await res.json();

            let text = "Debug Result:\n";
            if (data.autoread) text += `Autoread: ${data.autoread.status} (${data.autoread.reason})\n`;
            if (data.autoreact) text += `Autoreact: ${data.autoreact.status} (${data.autoreact.detail})`;

            showToast(text);
        } catch (e) {
            console.error(e);
            showToast("Debug Request Failed");
        } finally {
            el.style.opacity = '1';
        }
    }

    // --- Autoreact Logic ---
    function toggleArBody() {
        document.getElementById('ar-body').classList.toggle('open');
    }

    async function loadArSettings() {
        try {
            let url = `/api/rules/autoreact/get?chat_id=${chatId}`;
            if (topicId) url += `&topic_id=${topicId}`;
            const res = await fetch(url);
            const data = await res.json();

            arConfig.enabled = data.enabled;
            if (data.config.emoji) arConfig.emoji = data.config.emoji;
            if (data.config.target_users) arConfig.target_users = data.config.target_users;

            renderArUi();
        } catch (e) { console.error("Failed to load AR settings", e); }
    }

    let usersLoaded = false;
    async function loadUsers() {
        if (usersLoaded) return;
        const dd = document.getElementById('user-dropdown');
        try {
            const res = await fetch(`/api/chat/${chatId}/authors`);
            const data = await res.json();
            availableUsers = data.authors;
            usersLoaded = true;
            renderUserDropdown();
            renderUserDisplay();
        } catch (e) {
            dd.innerHTML = '<div style="padding:10px; color:red;">Failed to load users</div>';
        }
    }

    function renderArUi() {
        document.getElementById('autoreact-checkbox').checked = arConfig.enabled;

        document.querySelectorAll('.emoji-opt').forEach(el => {
            if (el.getAttribute('data-emoji') === arConfig.emoji) {
                el.classList.add('selected');
                document.getElementById('custom-emoji-input').value = '';
            } else {
                el.classList.remove('selected');
            }
        });

        const predefined = ['üí©', 'ü§°', '‚ù§Ô∏è'];
        if (!predefined.includes(arConfig.emoji)) {
            document.getElementById('custom-emoji-input').value = arConfig.emoji;
        }

        renderUserDisplay();
    }

    function renderUserDisplay() {
        const display = document.getElementById('user-display');
        display.innerHTML = '';

        if (arConfig.target_users.length === 0) {
            display.innerHTML = '<span style="color: #666; font-style: italic;">Default (Channel)</span>';
            return;
        }

        arConfig.target_users.forEach(uid => {
            const user = availableUsers.find(u => u.id === uid);
            const name = user ? user.name : `ID: ${uid}`;
            const chip = document.createElement('div');
            chip.className = 'user-chip';
            chip.innerHTML = `${name} <span style="margin-left:5px; cursor:pointer;" onclick="event.stopPropagation(); removeUser(${uid})">&times;</span>`;
            display.appendChild(chip);
        });
    }

    function renderUserDropdown() {
        const dd = document.getElementById('user-dropdown');
        dd.innerHTML = '';
        availableUsers.forEach(u => {
            const isSelected = arConfig.target_users.includes(u.id);
            const item = document.createElement('div');
            item.className = 'user-item ' + (isSelected ? 'active' : '');

            const avatar = u.avatar_url ? `<img src="${u.avatar_url}">` : '<div style="width:24px;height:24px;background:#555;border-radius:50%;margin-right:10px;"></div>';

            item.innerHTML = `${avatar} <div>${u.name} <div style="font-size:0.75rem;color:#888;">${u.username || ''}</div></div>`;
            item.onclick = (e) => {
                event.stopPropagation();
                toggleUser(u.id);
            }
            dd.appendChild(item);
        });
    }

    function toggleUserDropdown() {
        const dd = document.getElementById('user-dropdown');
        if (!dd.classList.contains('show')) {
            loadUsers();
        }
        dd.classList.toggle('show');
    }

    // Dismiss dropdown on outside click
    document.addEventListener('click', function (e) {
        const dd = document.getElementById('user-dropdown');
        const display = document.getElementById('user-display');
        if (dd && dd.classList.contains('show')) {
            if (!dd.contains(e.target) && !display.contains(e.target)) {
                dd.classList.remove('show');
            }
        }
    });

    function toggleUser(uid) {
        if (arConfig.target_users.includes(uid)) {
            arConfig.target_users = arConfig.target_users.filter(id => id !== uid);
        } else {
            arConfig.target_users.push(uid);
        }
        renderUserDisplay();
        renderUserDropdown();
    }

    window.removeUser = function (uid) {
        arConfig.target_users = arConfig.target_users.filter(id => id !== uid);
        renderUserDisplay();
        renderUserDropdown();
    };

    document.querySelectorAll('.emoji-opt').forEach(el => {
        el.addEventListener('click', () => {
            arConfig.emoji = el.getAttribute('data-emoji');
            renderArUi();
        });
    });

    document.getElementById('custom-emoji-input').addEventListener('input', (e) => {
        if (e.target.value) {
            arConfig.emoji = e.target.value;
            document.querySelectorAll('.emoji-opt').forEach(opt => opt.classList.remove('selected'));
        }
    });

    document.getElementById('autoreact-checkbox').addEventListener('change', (e) => {
        arConfig.enabled = e.target.checked;
    });

    document.getElementById('save-ar-btn').addEventListener('click', async () => {
        const btn = document.getElementById('save-ar-btn');
        btn.textContent = 'Saving...';
        try {
            await fetch('/api/rules/autoreact/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: chatId,
                    topic_id: topicId,
                    enabled: arConfig.enabled,
                    config: {
                        emoji: arConfig.emoji,
                        target_users: arConfig.target_users
                    }
                })
            });
            btn.textContent = 'Saved!';
            setTimeout(() => btn.textContent = 'Save', 1000);
            toggleArBody();
        } catch (e) {
            btn.textContent = 'Error';
        }
    });

    loadArSettings();

    // --- Existing Chat Logic ---
    async function toggleReaction(el, msgId, emoji) {
        const container = el.parentNode;
        const isChosen = el.classList.contains('chosen');
        const countSpan = el.querySelector('.reaction-count');
        let count = parseInt(countSpan ? countSpan.textContent : '0');

        if (!isPremium) {
            const siblings = container.querySelectorAll('.reaction-pill.chosen');
            siblings.forEach(sib => {
                if (sib !== el) {
                    sib.classList.remove('chosen');
                    const sibCountSpan = sib.querySelector('.reaction-count');
                    let sibCount = parseInt(sibCountSpan.textContent);
                    if (sibCount > 0) sibCountSpan.textContent = sibCount - 1;
                }
            });
        }

        if (isChosen) {
            el.classList.remove('chosen');
            if (count > 0) countSpan.textContent = count - 1;
        } else {
            el.classList.add('chosen');
            countSpan.textContent = count + 1;
            el.style.transform = 'scale(1.2)';
            setTimeout(() => el.style.transform = '', 150);
        }

        try {
            const url = `/api/chat/${chatId}/message/${msgId}/reaction`;
            await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reaction: emoji.toString() })
            });
        } catch (e) {
            console.error('Failed to toggle reaction', e);
        }
    }

    document.getElementById('autoread-checkbox').addEventListener('change', async (e) => {
        const enabled = e.target.checked;
        await fetch('/api/rules/autoread/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: chatId, topic_id: topicId, enabled })
        });
    });

    {% if topic_id %}
    document.getElementById('apply-all-topics').addEventListener('click', async () => {
        const btn = document.getElementById('apply-all-topics');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<span style="margin-right: 6px;">‚è≥</span> Applying...';
        btn.style.opacity = '0.7';
        btn.style.pointerEvents = 'none';

        const checkbox = document.getElementById('autoread-checkbox');
        const enabled = checkbox.checked;

        try {
            await fetch('/api/rules/autoread/apply_all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ forum_id: chatId, enabled })
            });
            btn.innerHTML = '<span style="margin-right: 6px;">‚úÖ</span> Done!';
        } catch (e) {
            console.error(e);
            btn.innerHTML = '<span style="margin-right: 6px;">‚ùå</span> Error';
        } finally {
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            }, 1500);
        }
    });
    {% endif %}

    document.getElementById('btn-read-chat').addEventListener('click', async () => {
        const btn = document.getElementById('btn-read-chat');
        btn.style.opacity = '0.5';
        btn.style.pointerEvents = 'none';

        try {
            const url = `/api/chat/${chatId}/read`;
            await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic_id: topicId })
            });

            if (topicId) {
                window.location.href = `/forum/${chatId}`;
            } else {
                window.location.href = `/`;
            }
        } catch (e) {
            console.error(e);
            setTimeout(() => {
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            }, 500);
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="messages-container" id="messages-container">
    {% include "chat/messages_partial.html.j2" %}
</div>

<div id="loading-indicator" style="display: none; text-align: center; padding: 10px; color: #666;">
    Loading...
</div>

<script>
    const container = document.getElementById('messages-container');
    const currentTopicId = {{ topic_id or 'null' }};
    let isLoading = false;
    let allLoaded = false;

    window.scrollTo(0, document.body.scrollHeight);

    window.addEventListener('scroll', () => {
        if (isLoading || allLoaded) return;
        if (window.scrollY < 100) {
            loadOlderMessages();
        }
    });

    async function loadOlderMessages() {
        isLoading = true;
        const indicator = document.getElementById('loading-indicator');
        indicator.style.display = 'block';

        const messages = container.querySelectorAll('.message-row');
        if (messages.length === 0) {
            isLoading = false;
            return;
        }

        const oldestMsg = messages[messages.length - 1];
        const offsetId = oldestMsg.getAttribute('data-id');
        const previousHeight = document.body.scrollHeight;

        try {
            let url = `/api/chat/${chatId}/history?offset_id=${offsetId}`;
            if (currentTopicId) url += `&topic_id=${currentTopicId}`;

            const response = await fetch(url);
            const data = await response.json();

            if (data.count === 0) {
                allLoaded = true;
            } else {
                container.insertAdjacentHTML('beforeend', data.html);
                window.parseAppleEmojis(container);
                const newHeight = document.body.scrollHeight;
                window.scrollTo(0, newHeight - previousHeight);
            }
        } catch (error) {
            console.error('Failed to load history:', error);
        } finally {
            isLoading = false;
            indicator.style.display = 'none';
        }
    }

    // Helper to build reaction HTML from JSON data
    function buildReactionsHtml(msgId, reactions) {
        let html = '';
        reactions.forEach(r => {
            const chosenClass = r.is_chosen ? 'chosen' : '';
            const emojiVal = r.custom_emoji_id || r.emoji;

            let innerContent = '';
            if (r.custom_emoji_id) {
                innerContent = `<img src="/media/custom_emoji/${r.custom_emoji_id}" style="width: 20px; height: 20px; margin-right: 4px;">`;
            } else {
                // Force Emoji Presentation (\uFE0F) so Twemoji picks it up
                innerContent = `<span>${r.emoji}\uFE0F</span>`;
            }

            html += `
            <div class="reaction-pill ${chosenClass}" data-emoji="${emojiVal}"
                onclick="toggleReaction(this, ${msgId}, '${emojiVal}')">
                ${innerContent}
                <span class="reaction-count">${r.count}</span>
            </div>`;
        });
        return html;
    }

    document.addEventListener('tg:event', (e) => {
        const data = e.detail;

        if (data.chat_id !== chatId) return;

        if (currentTopicId && data.topic_id !== currentTopicId) {
            if (data.topic_id) return;
        }

        if (data.type === 'message') {
            if (data.rendered_html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = data.rendered_html;
                window.parseAppleEmojis(tempDiv);

                container.insertAdjacentHTML('afterbegin', tempDiv.innerHTML);
                if (window.scrollY > document.body.scrollHeight - window.innerHeight - 300) {
                    window.scrollTo(0, document.body.scrollHeight);
                }
            }
        }
        else if (data.type === 'edited' && data.message_model) {
            const msgId = data.message_model.id;
            const msgRow = document.getElementById(`msg-${msgId}`);
            if (msgRow) {
                const textEl = msgRow.querySelector('.text');
                if (textEl) {
                    textEl.innerHTML = data.message_model.text;
                    window.parseAppleEmojis(textEl);

                    if (!msgRow.querySelector('.edited-label')) {
                        const timeEl = msgRow.querySelector('.time');
                        const editedSpan = document.createElement('span');
                        editedSpan.className = 'edited-label';
                        editedSpan.style.fontSize = '0.7em';
                        editedSpan.style.color = '#999';
                        editedSpan.style.marginRight = '4px';
                        editedSpan.innerText = '(edited)';
                        if (timeEl) timeEl.parentNode.insertBefore(editedSpan, timeEl);
                    }
                }
            }
        }
        else if (data.type === 'deleted' && data.message_model) {
            const msgId = data.message_model.id;
            const msgRow = document.getElementById(`msg-${msgId}`);
            if (msgRow) {
                msgRow.style.transition = 'opacity 0.3s, height 0.3s';
                msgRow.style.opacity = '0';
                setTimeout(() => msgRow.remove(), 300);
            }
        }
        else if (data.type === 'reaction_update' && data.message_model) {
            const msgId = data.message_model.id;
            const reactionsContainer = document.getElementById(`reactions-${msgId}`);
            if (reactionsContainer) {
                reactionsContainer.innerHTML = buildReactionsHtml(msgId, data.message_model.reactions);
                window.parseAppleEmojis(reactionsContainer);
            }
        }
    });
</script>
{% endblock %}
