{% extends "base.html.j2" %}

{% block title %}
{% if chat %}
{{ chat.name }}
{% else %}
Messages
{% endif %}
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="/static/css/chat_styles.css?t={{ 'static/css/chat_styles.css' | file_mtime }}">
{% endblock %}

{% block sidebar_back %}
{% if topic_id %}
<a href="/forum/{{ chat_id }}" class="back-link">‚Üê Back to Topics</a>
{% else %}
<a href="/" class="back-link">‚Üê Back to Chats</a>
{% endif %}
{% endblock %}

{% block sidebar_info %}
{% if chat %}
<div style="text-align: center; margin-bottom: 20px;">
    {% if chat.image_url %}
    <img src="{{ chat.image_url }}"
        style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;">
    {% else %}
    <div
        style="width: 80px; height: 80px; border-radius: 50%; background: #333; margin: 0 auto 10px auto; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #aaa;">
        {{ chat.name[0] | upper }}
    </div>
    {% endif %}
    <h3 style="margin: 0; font-size: 1.1rem;">{{ chat.name }}</h3>
    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">{{ chat.type.value | title }}</p>
</div>

<!-- ACTIONS CONTAINER -->
<div class="chat-actions-container">
    <div class="actions-header">Actions</div>
    <div class="actions-grid">
        <!-- Autoread Toggle -->
        <div class="action-item" id="btn-toggle-autoread" title="Toggle Autoread">
            <span class="icon">üëÄ</span>
            <span class="label">Autoread</span>
            <div class="status-indicator {{ 'on' if autoread_enabled else 'off' }}"></div>
        </div>

        <!-- Autoreact Modal Trigger -->
        <div class="action-item" id="btn-open-autoreact" title="Configure Autoreact">
            <span class="icon">‚ö°</span>
            <span class="label">Autoreact</span>
            <!-- Status: all (green), some (yellow), off (grey) -->
            <div class="status-indicator status-{{ autoreact_status }}" id="autoreact-indicator"></div>
        </div>

        <!-- Mark Read Button -->
        <div class="action-item" id="btn-read-chat" title="Mark All Read">
            <span class="icon">‚úÖ</span>
            <span class="label">Mark Read</span>
        </div>

        {% if topic_id %}
        <!-- Apply to All Topics (Forum specific) -->
        <div class="action-item" id="btn-apply-topics" title="Copy Autoread to All Topics">
            <span class="icon">üìã</span>
            <span class="label">Copy All</span>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block content %}
<div class="messages-container" id="messages-container">
    {% include "chat/messages_partial.html.j2" %}
</div>

<div id="loading-indicator" style="display: none; text-align: center; padding: 10px; color: #666;">
    Loading...
</div>

<!-- Toast Container -->
<div id="toast"></div>

<!-- Autoreact Modal -->
<div id="autoreact-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Autoreact Configuration</h3>
            <span class="modal-close" onclick="closeArModal()">&times;</span>
        </div>
        <div class="modal-body">
            <label class="toggle-switch-wrapper">
                <input type="checkbox" id="autoreact-checkbox">
                <span class="toggle-slider"></span>
                <span class="toggle-label">Enable Autoreact</span>
            </label>

            <div class="section-label">Reaction Emoji</div>
            <div class="emoji-selector" id="emoji-selector">
                <div class="emoji-opt selected" data-emoji="üí©">üí©</div>
                <div class="emoji-opt" data-emoji="ü§°">ü§°</div>
                <div class="emoji-opt" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
                <input type="text" id="custom-emoji-input" placeholder="Custom" maxlength="4">
            </div>

            <!-- CHANNEL CHECK -->
            <div id="ar-user-section" style="display: {{ 'none' if chat.type.value == 'channel' else 'block' }};">
                <div class="section-label">Target Users (Optional)</div>
                <div class="user-selector-wrapper">
                    <div class="user-selector-display" id="user-display" onclick="toggleUserDropdown()">
                        <span style="color: #666; font-style: italic;">Loading...</span>
                    </div>
                    <div class="user-dropdown" id="user-dropdown">
                        <div style="padding: 10px; color: #aaa; font-style: italic;">Loading users...</div>
                    </div>
                </div>

                <!-- Warning Message -->
                <div id="ar-warning-box"
                    style="margin-top: 15px; background: rgba(244, 67, 54, 0.1); border: 1px solid #f44336; border-radius: 4px; padding: 10px; display: none;">
                    <strong style="color: #f44336;">‚ö†Ô∏è High Risk of Flood Wait</strong>
                    <p style="margin: 5px 0 0 0; color: #ddd; font-size: 0.85rem;">
                        Autoreacting to <strong>ALL messages</strong> may cause Telegram to temporarily ban this account
                        from interactions. Use with caution.
                    </p>
                </div>
                <div class="help-text" id="ar-help-text">Leave empty to react to ALL incoming messages.</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeArModal()">Cancel</button>
            <button class="btn-save" id="save-ar-btn">Save Configuration</button>
        </div>
    </div>
</div>

<script src="/static/js/chat.js?t={{ 'static/js/chat.js' | file_mtime }}"></script>
<script>
    const chatId = {{ chat_id }};
    const topicId = {{ topic_id or 'null' }};
    const isPremium = {{ 'true' if is_premium else 'false' }};
    const isChannel = {{ 'true' if chat.type.value == 'channel' else 'false' }};

    document.addEventListener('DOMContentLoaded', () => {
        initAutoread(chatId, topicId);
        initMarkRead(chatId, topicId);
        initAutoreact(chatId, topicId, isChannel);
        initInfiniteScroll(chatId, topicId);
        initChatEvents(chatId, topicId, isPremium);

        // Copy Topics Logic (Inline for now as it's specific)
        const copyTopicsBtn = document.getElementById('btn-apply-topics');
        if (copyTopicsBtn) {
            copyTopicsBtn.addEventListener('click', async () => {
                if (!confirm("Enable autoread for ALL topics in this forum?")) return;
                copyTopicsBtn.style.opacity = '0.5';
                try {
                    await fetch('/api/rules/autoread/apply_all', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ forum_id: chatId, enabled: true })
                    });
                    showToast("Applied to all topics");
                } catch (e) {
                    showToast("Failed to apply");
                } finally {
                    copyTopicsBtn.style.opacity = '1';
                }
            });
        }
    });

    // Debug Process
    async function debugProcessMessage(el, msgId) {
        el.style.opacity = '0.5';
        try {
            const res = await fetch('/api/debug/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: chatId, msg_id: msgId })
            });
            const data = await res.json();
            let text = "Debug:\n";
            if (data.autoread) text += `Read: ${data.autoread.status} (${data.autoread.reason})\n`;
            if (data.autoreact) text += `React: ${data.autoreact.status} (${data.autoreact.detail})`;
            showToast(text);
        } catch (e) {
            console.error(e);
            showToast("Debug Request Failed");
        } finally {
            el.style.opacity = '1';
        }
    }

    // Global toggle wrapper to pass extra args
    window.toggleReaction = (el, msgId, emoji) => {
        // We pass local chatId/isPremium context to the extracted function
        toggleReaction(el, msgId, emoji, chatId, isPremium);
    };
</script>
{% endblock %}
