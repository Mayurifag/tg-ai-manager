{% extends "base.html.j2" %}

{% block title %}
{% if chat %}
{{ chat.name }}
{% else %}
Messages
{% endif %}
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="/static/css/chat_styles.css?v={{ range(1, 10000) | random }}">
{% endblock %}

{% block content %}
<div class="header">
    <a href="javascript:history.back()" class="back-link">‚Üê Back</a>
    {% if chat %}
    <span style="font-weight: bold; margin-left: 10px;">{{ chat.name }}</span>
    {% endif %}
</div>

<div class="messages-container" id="messages-container">
    {% include "chat/messages_partial.html.j2" %}
</div>

<!-- Loading spinner (hidden by default) -->
<div id="loading-indicator" style="display: none; text-align: center; padding: 10px; color: #666;">
    Loading...
</div>

<script>
    const container = document.getElementById('messages-container');
    const chatId = {{ chat_id }};
    const topicId = {{ topic_id or 'null' }};
    let isLoading = false;
    let allLoaded = false;

    window.scrollTo(0, document.body.scrollHeight);

    window.addEventListener('scroll', () => {
        if (isLoading || allLoaded) return;

        // Detect if scrolled to top
        if (window.scrollY < 100) {
            loadOlderMessages();
        }
    });

    async function loadOlderMessages() {
        isLoading = true;
        const indicator = document.getElementById('loading-indicator');
        indicator.style.display = 'block';

        // Find the ID of the oldest message (visually top, so physically last in DOM list)
        const messages = container.querySelectorAll('.message-row');
        if (messages.length === 0) {
            isLoading = false;
            return;
        }

        const oldestMsg = messages[messages.length - 1];
        const offsetId = oldestMsg.getAttribute('data-id');

        // Save scroll height before appending
        const previousHeight = document.body.scrollHeight;

        try {
            let url = `/api/chat/${chatId}/history?offset_id=${offsetId}`;
            if (topicId) url += `&topic_id=${topicId}`;

            const response = await fetch(url);
            const data = await response.json();

            if (data.count === 0) {
                allLoaded = true;
            } else {
                // Append new messages to the end of the container (Visual Top)
                container.insertAdjacentHTML('beforeend', data.html);

                // Adjust scroll position to maintain view
                const newHeight = document.body.scrollHeight;
                window.scrollTo(0, newHeight - previousHeight);
            }
        } catch (error) {
            console.error('Failed to load history:', error);
        } finally {
            isLoading = false;
            indicator.style.display = 'none';
        }
    }
</script>
{% endblock %}