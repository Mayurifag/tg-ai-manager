{% for msg in messages %}

{% if msg.is_service %}
<div class="service-message-row" id="msg-{{ msg.id }}" data-id="{{ msg.id }}">
    <div class="service-message-bubble">
        {{ msg.sender_name }} {{ msg.text }}
    </div>
</div>
{% else %}
<div class="message-row {{ 'outgoing' if msg.is_outgoing else 'incoming' }}" id="msg-{{ msg.id }}"
    data-id="{{ msg.id }}">
    {% if not msg.is_outgoing %}
    <div class="message-avatar"
        style="width: 35px; height: 35px; min-width: 35px; margin-right: 8px; border-radius: 50%; overflow: hidden; flex-shrink: 0;">
        {% if msg.avatar_url %}
        <img src="{{ msg.avatar_url }}" alt="{{ msg.sender_initials }}"
            style="width: 100%; height: 100%; object-fit: cover; display: block;">
        {% else %}
        <div class="avatar-placeholder"
            style="background-color: {{ msg.sender_color or '#ccc' }}; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: bold; text-transform: uppercase;">
            {{ msg.sender_initials or '?' }}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="message-bubble">
        {% if not msg.is_outgoing and msg.sender_name %}
        <span class="sender">{{ msg.sender_name }}</span>
        {% endif %}

        {% if msg.reply_to_msg_id %}
        <a href="#msg-{{ msg.reply_to_msg_id }}" class="reply-indicator">
            <div class="reply-content">
                <div class="reply-name">{{ msg.reply_to_sender_name or 'Unknown' }}</div>
                <div class="reply-text">{{ msg.reply_to_text or 'Message unavailable' }}</div>
            </div>
        </a>
        {% endif %}

        {% if msg.album_parts %}
        <div class="media-content">
            {% set count = msg.album_parts | length %}
            <div class="album-grid items-{{ count if count <= 4 else 'more' }}">
                {% for part in msg.album_parts %}
                <div class="album-item">
                    {% if part.is_video %}
                    <video controls preload="metadata" style="width: 100%; height: 100%; object-fit: cover;">
                        <source src="/media/{{ chat_id }}/{{ part.id }}">
                    </video>
                    {% else %}
                    <img src="/media/{{ chat_id }}/{{ part.id }}" class="lightbox-trigger"
                        data-full-src="/media/{{ chat_id }}/{{ part.id }}/full" onclick="openLightbox(this)"
                        loading="lazy">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        {% elif msg.has_media %}
        <div class="media-content" style="margin-bottom: 5px;">
            {% if msg.is_video %}
            <video controls preload="metadata"
                style="max-width: 100%; border-radius: 8px; max-height: 400px; display: block;">
                <source src="/media/{{ chat_id }}/{{ msg.id }}">
            </video>

            {% elif msg.is_sticker %}
            {% if msg.sticker_emoji %}<!-- Alt Text -->{% endif %}
            <!-- Check if sticker is Lottie (JSON) or Image -->
            <!-- We can detect this via JS usually, but for now simple img.
                     Lottie Stickers would need separate handling if we download them as .json -->
            <img src="/media/{{ chat_id }}/{{ msg.id }}" loading="lazy"
                style="max-width: 300px; max-height: 300px; display: block;" alt="Sticker">

            {% elif msg.is_audio %}
            <div class="audio-player"
                style="background: rgba(0,0,0,0.05); padding: 8px; border-radius: 8px; min-width: 250px;">
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <span style="font-size: 1.5rem; margin-right: 10px;">
                        {{ 'üé§' if msg.is_voice else 'üéµ' }}
                    </span>
                    <div style="overflow: hidden;">
                        {% if msg.audio_title or msg.audio_performer %}
                        <div style="font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ msg.audio_title or 'Unknown Title' }}</div>
                        <div
                            style="font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ msg.audio_performer or 'Unknown Artist' }}</div>
                        {% else %}
                        <div style="font-weight: bold;">Audio File</div>
                        {% endif %}
                    </div>
                </div>
                <audio controls preload="none" style="width: 100%; height: 30px;">
                    <source src="/media/{{ chat_id }}/{{ msg.id }}">
                </audio>
            </div>

            {% elif msg.is_poll %}
            <div class="poll-content"
                style="background: #f0f4f7; padding: 10px; border-radius: 8px; border: 1px solid #cfd8dc; color: #37474f; min-width: 250px;">
                <div style="font-weight: bold; font-size: 1.05rem; margin-bottom: 5px;">üó≥Ô∏è Poll: {{ msg.poll_question
                    or 'Unknown Poll' }}</div>
            </div>

            {% else %}
            <img src="/media/{{ chat_id }}/{{ msg.id }}" loading="lazy" class="inline-media lightbox-trigger"
                data-full-src="/media/{{ chat_id }}/{{ msg.id }}/full"
                style="max-width: 250px; max-height: 300px; border-radius: 8px; display: block; cursor: pointer;"
                onclick="openLightbox(this)">
            {% endif %}
        </div>
        {% endif %}

        {% if msg.text %}
        <div class="text">{{ msg.text | safe }}</div>
        {% endif %}

        <div class="reactions-container" id="reactions-{{ msg.id }}">
            {% for r in msg.reactions %}
            <div class="reaction-pill {{ 'chosen' if r.is_chosen else '' }}"
                data-emoji="{{ r.custom_emoji_id if r.custom_emoji_id else r.emoji }}"
                onclick="window.toggleReaction(this, {{ msg.id }}, '{{ r.custom_emoji_id if r.custom_emoji_id else r.emoji }}')">
                {% if r.custom_emoji_id %}
                <!-- Use img for preview, JS checks if it needs Lottie replacement based on src extension -->
                <!-- We use onerror to handle potential loading issues, but main logic is in JS if we want lottie. -->
                <!-- Since backend now unzips .tgs to .json, we can check extension via JS or assume image for simple view.
                         However, `src` here points to /media/custom_emoji/ID. The route returns redirect.
                         Browser <img src="...json"> wont work.
                         We need a div container for Lottie. -->

                <div class="lottie-anim" data-path="/media/custom_emoji/{{ r.custom_emoji_id }}"
                    style="width: 20px; height: 20px; margin-right: 4px;"></div>
                {% else %}
                <span>{{ r.emoji }}&#xFE0F;</span>
                {% endif %}
                <span class="reaction-count">{{ r.count }}</span>
            </div>
            {% endfor %}
        </div>

        <div class="hover-reaction" onclick="window.toggleReaction(this, {{ msg.id }}, 'üí©')" title="React with üí©">
            üí©
        </div>

        {% if current_user and current_user.debug_mode %}
        <div class="debug-process" onclick="debugProcessMessage(this, {{ msg.id }})" title="Dry Run Rules">
            ‚öôÔ∏è
        </div>
        {% endif %}

        <div class="time local-time" data-timestamp="{{ msg.date.isoformat() }}"></div>
    </div>
</div>
{% endif %}
{% endfor %}
