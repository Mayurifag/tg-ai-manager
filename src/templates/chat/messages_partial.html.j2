{% for msg in messages %}

{% if msg.is_service %}
<div class="service-message-row" id="msg-{{ msg.id }}" data-id="{{ msg.id }}">
    <div class="service-message-bubble">
        {{ msg.sender_name }} {{ msg.text }}
    </div>
</div>
{% else %}
<div class="message-row {{ 'outgoing' if msg.is_outgoing else 'incoming' }}" id="msg-{{ msg.id }}"
    data-id="{{ msg.id }}">
    {% if not msg.is_outgoing %}
    <div class="message-avatar"
        style="width: 35px; height: 35px; min-width: 35px; margin-right: 8px; border-radius: 50%; overflow: hidden; flex-shrink: 0;">
        {% if msg.avatar_url %}
        <img src="{{ msg.avatar_url }}" alt="{{ msg.sender_initials }}"
            style="width: 100%; height: 100%; object-fit: cover; display: block;">
        {% else %}
        <div class="avatar-placeholder"
            style="background-color: {{ msg.sender_color or '#ccc' }}; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: bold; text-transform: uppercase;">
            {{ msg.sender_initials or '?' }}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="message-bubble">
        {% if not msg.is_outgoing and msg.sender_name %}
        <span class="sender">{{ msg.sender_name }}</span>
        {% endif %}

        {% if msg.reply_to_msg_id %}
        <a href="#msg-{{ msg.reply_to_msg_id }}" class="reply-indicator">
            <div class="reply-content">
                <div class="reply-name">{{ msg.reply_to_sender_name or 'Unknown' }}</div>
                <div class="reply-text">{{ msg.reply_to_text or 'Message unavailable' }}</div>
            </div>
        </a>
        {% endif %}

        {% if msg.has_media %}
        <div class="media-content" style="margin-bottom: 5px;">
            {% if msg.is_video %}
            <video controls preload="metadata"
                style="max-width: 100%; border-radius: 8px; max-height: 400px; display: block;">
                <source src="/media/{{ chat_id }}/{{ msg.id }}">
                Your browser does not support the video tag.
            </video>

            {% elif msg.is_sticker %}
            <img src="/media/{{ chat_id }}/{{ msg.id }}" loading="lazy"
                style="max-width: 300px; max-height: 300px; display: block;" alt="Sticker">

            {% elif msg.is_audio %}
            <div class="audio-player"
                style="background: rgba(0,0,0,0.05); padding: 8px; border-radius: 8px; min-width: 250px;">
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <span style="font-size: 1.5rem; margin-right: 10px;">
                        {{ 'üé§' if msg.is_voice else 'üéµ' }}
                    </span>
                    <div style="overflow: hidden;">
                        {% if msg.audio_title or msg.audio_performer %}
                        <div style="font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ msg.audio_title or 'Unknown Title' }}</div>
                        <div
                            style="font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ msg.audio_performer or 'Unknown Artist' }}</div>
                        {% else %}
                        <div style="font-weight: bold;">Audio File</div>
                        {% endif %}
                    </div>
                </div>
                <audio controls preload="none" style="width: 100%; height: 30px;">
                    <source src="/media/{{ chat_id }}/{{ msg.id }}">
                    Your browser does not support the audio element.
                </audio>
            </div>

            {% elif msg.is_poll %}
            <div class="poll-content"
                style="background: #f0f4f7; padding: 10px; border-radius: 8px; border: 1px solid #cfd8dc; color: #37474f; min-width: 250px;">
                <div style="font-weight: bold; font-size: 1.05rem; margin-bottom: 5px;">üó≥Ô∏è Poll: {{ msg.poll_question
                    or 'Unknown Poll' }}</div>
                <div style="font-size: 0.9rem; color: #666;">Poll content is not yet fully displayed.</div>
            </div>

            {% else %}
            {# Photos/General Media #}
            <img src="/media/{{ chat_id }}/{{ msg.id }}" loading="lazy" class="inline-media"
                style="max-width: 250px; max-height: 300px; border-radius: 8px; display: block; cursor: pointer;"
                onclick="window.open(this.src, '_blank')">
            {% endif %}
        </div>
        {% endif %}

        {% if msg.text %}
        <div class="text">{{ msg.text | safe }}</div>
        {% endif %}

        <div class="time">{{ msg.date.strftime('%H:%M') }}</div>
    </div>
</div>
{% endif %}
{% endfor %}
