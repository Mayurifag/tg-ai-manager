{% macro render_chat_card(chat, parent_id=none) %}
{# Determine the correct link for the chat or topic #}
{% set link = "/chat/" ~ chat.id %}
{% if chat.type.value == 'forum' %}
{% set link = "/forum/" ~ chat.id %}
{% elif chat.type.value == 'topic' and parent_id is not none %}
{% set link = "/chat/" ~ parent_id ~ "/topic/" ~ chat.id %}
{% endif %}

<a href="{{ link }}" class="chat-card" data-chat-type="{{ chat.type.value }}" {% if chat.is_pinned
    %}data-is-pinned="true" {% endif %}>
    <div class="chat-content">
        {# --- Avatar/Icon --- #}
        {% if chat.type.value == 'topic' %}
        <div class="avatar" style="background-color: #e0f7fa;">
            {% if chat.icon_emoji %}
            {{ chat.icon_emoji }}
            {% else %}
            {{ chat.name[0] | upper }}
            {% endif %}
        </div>
        {% elif chat.image_url %}
        <img src="{{ chat.image_url }}" class="avatar" alt="Avatar" loading="lazy">
        {% else %}
        <div class="avatar">{{ chat.name[0] | upper }}</div>
        {% endif %}

        {# --- Chat Info --- #}
        <div class="chat-info">
            {% if chat.type.value != 'topic' %}
            <div class="chat-header">
                <span class="chat-name" title="{{ chat.name }}">{{ chat.name }}</span>
                {% if chat.is_pinned %}
                <span class="pinned-indicator" title="Pinned Chat">ðŸ“Œ</span>
                {% endif %}
                <span class="badge">{{ chat.type.value }}</span>

                {# "Mark Read" Button moved to header line #}
                {% if chat.unread_count > 0 %}
                <button class="mark-read-btn" data-chat-id="{{ parent_id if chat.type.value == 'topic' else chat.id }}"
                    data-topic-id="{{ chat.id if chat.type.value == 'topic' else '' }}" title="Mark as Read">
                    mark read
                </button>
                {% endif %}
            </div>
            {% else %}
            <div class="chat-header">
                <span class="chat-name" title="{{ chat.name }}">{{ chat.name }}</span>

                {# "Mark Read" Button for topics #}
                {% if chat.unread_count > 0 %}
                <button class="mark-read-btn" data-chat-id="{{ parent_id if chat.type.value == 'topic' else chat.id }}"
                    data-topic-id="{{ chat.id if chat.type.value == 'topic' else '' }}" title="Mark as Read">
                    mark read
                </button>
                {% endif %}
            </div>
            {% endif %}

            <div class="preview">
                {{ (chat.last_message_preview or 'No messages') | safe }}
            </div>
        </div>
    </div>

    {# --- Meta/Unread Count --- #}
    {% if chat.unread_count > 0 %}
    <div class="meta">
        <div class="unread">
            {{ chat.unread_count }}
        </div>
    </div>
    {% endif %}
</a>
{% endmacro %}
