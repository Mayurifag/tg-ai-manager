<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="color-scheme" content="dark">
    <meta name="supported-color-scheme" content="dark">
    <title>{% block title %}Telegram Manager{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?t={{ 'static/favicon.svg' | file_mtime }}">
    <link rel="stylesheet" href="/static/css/base.css?t={{ 'static/css/base.css' | file_mtime }}">
    {% block head_extra %}{% endblock %}
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-top">
                {% block sidebar_back %}
                {% endblock %}
            </div>

            <div class="sidebar-content">
                {% block sidebar_info %}
                {% endblock %}
            </div>

            <div class="sidebar-feed">
                <div class="settings-header">Live Events</div>
                <div id="event-feed-list">
                    {% if recent_events %}
                    {% for event in recent_events %}
                    {% if event.type not in ['read', 'edited'] %}
                    <div class="event-item type-{{ event.type }}">
                        <div class="event-header">
                            <span class="event-type">{{ event.type | upper }}</span>
                            <span class="event-chat" {% if event.topic_name
                                %}title="{{ event.topic_name }} - {{ event.chat_name }}" {% endif %}>{{ event.chat_name
                                }}</span>
                        </div>
                        <div class="event-text" title="{{ event.text }}">{{ event.text }}</div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <div class="empty-feed">No recent events</div>
                    {% endif %}
                </div>
            </div>

            <div class="sidebar-settings">
                <div class="settings-header">Settings</div>

                <a href="/settings" class="setting-option" style="text-decoration: none;">
                    ‚öôÔ∏è Global Settings
                </a>

                <a href="/actions" class="setting-option" style="text-decoration: none;">
                    üìú Actions Log
                </a>

                {% block settings %}
                {% endblock %}
            </div>
        </aside>

        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox" onclick="closeLightbox()">
        <div class="lightbox-close" onclick="closeLightbox()">&times;</div>

        <button class="lightbox-nav nav-prev" onclick="event.stopPropagation(); navigateLightbox(-1)">&#10094;</button>
        <button class="lightbox-nav nav-next" onclick="event.stopPropagation(); navigateLightbox(1)">&#10095;</button>

        <div id="lightbox-loading">Loading full size...</div>
        <img id="lightbox-img" src="" alt="Full View" onclick="event.stopPropagation()">
    </div>

    <script>
        let currentLightboxIndex = -1;
        let lightboxItems = [];

        function refreshLightboxItems() {
            // Find all elements classed as 'lightbox-trigger'
            // We use Array.from to get a static list at the moment of call
            // We reverse logic if message container is column-reverse?
            // Actually, querySelectorAll returns in document order.
            // If the chat is column-reverse, the first element in DOM is the bottom one.
            // We usually want navigation to follow visual flow (Top to Bottom).
            // So standard DOM order (Top to Bottom) is correct for visual flow.
            const triggers = document.querySelectorAll('.lightbox-trigger');
            lightboxItems = Array.from(triggers).map(el => ({
                el: el,
                src: el.src,
                fullSrc: el.getAttribute('data-full-src')
            }));
        }

        // Global Lightbox Functions
        function openLightbox(element) {
            refreshLightboxItems();

            // Find index of clicked element
            currentLightboxIndex = lightboxItems.findIndex(item => item.el === element);

            if (currentLightboxIndex === -1) return;

            updateLightboxView();

            const lightbox = document.getElementById('lightbox');
            lightbox.classList.add('active');
        }

        function updateLightboxView() {
            const item = lightboxItems[currentLightboxIndex];
            const img = document.getElementById('lightbox-img');
            const loader = document.getElementById('lightbox-loading');

            if (!item) return;

            // Reset UI
            img.style.display = 'none';
            loader.style.display = 'block';

            // Set source
            img.onload = () => {
                loader.style.display = 'none';
                img.style.display = 'block';
            };
            img.onerror = () => {
                console.log("Full load failed, falling back to preview");
                img.src = item.src;
                loader.style.display = 'none';
                img.style.display = 'block';
            };

            // Use full resolution source
            img.src = item.fullSrc;
        }

        function navigateLightbox(dir) {
            const newIndex = currentLightboxIndex + dir;
            if (newIndex >= 0 && newIndex < lightboxItems.length) {
                currentLightboxIndex = newIndex;
                updateLightboxView();
            }
        }

        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.remove('active');
            const img = document.getElementById('lightbox-img');
            setTimeout(() => img.src = "", 300);
        }

        // Keyboard Navigation
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('lightbox').classList.contains('active')) return;

            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') navigateLightbox(-1);
            if (e.key === 'ArrowRight') navigateLightbox(1);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const feedContainer = document.getElementById('event-feed-list');
            const evtSource = new EventSource("/api/events/stream");

            evtSource.onmessage = function (e) {
                const data = JSON.parse(e.data);
                const customEvent = new CustomEvent('tg:event', { detail: data });
                document.dispatchEvent(customEvent);

                if (data.type === 'read' || data.type === 'edited') return;

                const emptyMsg = feedContainer.querySelector('.empty-feed');
                if (emptyMsg) emptyMsg.remove();

                const item = document.createElement('div');
                item.className = `event-item type-${data.type}`;

                const header = document.createElement('div');
                header.className = 'event-header';
                const typeSpan = document.createElement('span');
                typeSpan.className = 'event-type';
                typeSpan.textContent = data.type.toUpperCase();
                const chatSpan = document.createElement('span');
                chatSpan.className = 'event-chat';
                chatSpan.textContent = data.chat_name;
                if (data.topic_name) chatSpan.title = `${data.topic_name} - ${data.chat_name}`;
                header.appendChild(typeSpan);
                header.appendChild(chatSpan);

                const textDiv = document.createElement('div');
                textDiv.className = 'event-text';
                textDiv.textContent = data.text;
                item.appendChild(header);
                item.appendChild(textDiv);

                feedContainer.insertBefore(item, feedContainer.firstChild);
                const items = feedContainer.querySelectorAll('.event-item');
                if (items.length > 10) items[items.length - 1].remove();
            };
        });
    </script>
</body>

</html>
