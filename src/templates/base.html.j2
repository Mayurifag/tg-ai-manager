<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="color-scheme" content="dark">
    <meta name="supported-color-scheme" content="dark">
    <title>{% block title %}Telegram Manager{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?t={{ 'static/favicon.svg' | file_mtime }}">
    <link rel="stylesheet" href="/static/css/base.css?t={{ 'static/css/base.css' | file_mtime }}">
    <!-- Local Twemoji Library -->
    <script src="/static/libs/twemoji/twemoji.min.js"></script>
    <script>
        // Global helper to parse Apple Emojis using local assets
        window.parseAppleEmojis = function (container) {
            twemoji.parse(container, {
                folder: 'svg',
                ext: '.svg',
                callback: function (icon, options, variant) {
                    const cleanIcon = icon.replace(/-fe0f/g, '');
                    return '/static/emoji/apple/' + cleanIcon + '.png';
                }
            });
        };

        // Timezone Helper
        window.renderLocalTimes = function (context) {
            const els = (context || document).querySelectorAll('.local-time[data-timestamp]');
            els.forEach(el => {
                const iso = el.getAttribute('data-timestamp');
                if (iso) {
                    const date = new Date(iso);
                    // HH:MM format
                    const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                    el.textContent = timeStr;
                    el.classList.add('rendered');
                }
            });
        };
    </script>
    {% block head_extra %}{% endblock %}
</head>

<body>
    <div class="app-container">
        <!-- LEFT SIDEBAR -->
        <aside class="sidebar left-sidebar">
            <div class="sidebar-top">
                {% block sidebar_back %}
                {% endblock %}
            </div>

            <div class="sidebar-content">
                {% block sidebar_info %}
                {% endblock %}
            </div>

            <!-- Navigation Links -->
            <div class="sidebar-nav">
                <a href="/settings" class="setting-option">
                    ‚öôÔ∏è Settings
                </a>
                <a href="/actions" class="setting-option">
                    üìú Actions Log
                </a>
                {% block settings %}
                {% endblock %}
            </div>

            <!-- User Profile Section (Pinned Bottom) -->
            {% if current_user and current_user.username %}
            <div class="user-profile-section">
                <div class="sidebar-avatar">
                    {{ current_user.username[1] | upper if current_user.username|length > 1 else '?' }}
                </div>
                <div class="sidebar-user-info">
                    <div class="sidebar-username">{{ current_user.username }}</div>
                    <div class="sidebar-status">{{ 'Premium' if current_user.is_premium else 'Standard' }}</div>
                </div>
            </div>
            {% endif %}
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            {% block content %}{% endblock %}
        </main>

        <!-- RIGHT SIDEBAR (Live Events) - HIDDEN UNLESS DEBUG MODE -->
        {% if current_user and current_user.debug_mode %}
        <aside class="sidebar right-sidebar">
            <div class="sidebar-feed">
                <div class="settings-header" style="color: #6ab7ff;">Live Events (Debug)</div>
                <div id="event-feed-list">
                    {% if recent_events %}
                    {% for event in recent_events %}
                    {% if event.type not in ['read', 'edited', 'raw'] %}
                    <div class="event-item type-{{ event.type }}">
                        <div class="event-header">
                            {% if event.type == 'deleted' %}
                            <span class="event-type-icon" title="Deleted">üóëÔ∏è</span>
                            {% elif event.type == 'action' %}
                            <span class="event-type-icon" title="Action">‚ö°</span>
                            {% elif event.type == 'reaction_update' %}
                            <span class="event-type-icon" title="Reaction">üëç</span>
                            {% endif %}

                            <a href="{{ event.link or '#' }}" class="event-chat-link" {% if event.topic_name
                                %}title="{{ event.topic_name }}" {% endif %}>
                                {{ event.topic_name ~ ' - ' if event.topic_name else '' }}{{ event.chat_name }}
                            </a>
                        </div>

                        <!--
                          Event Text Wrapper
                          DEBUG MODE: shows raw JSON in tooltip via data-full-html
                        -->
                        <div class="event-text-wrapper" data-full-html="{{ event | to_json | escape }}">
                            <div class="event-text">
                                {{ event.text | safe }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <div class="empty-feed">No recent events</div>
                    {% endif %}
                </div>
            </div>
        </aside>
        {% endif %}
    </div>

    <!-- Global Tooltip -->
    <div id="global-tooltip"></div>

    <!-- Lightbox Modal -->
    <div id="lightbox" onclick="closeLightbox()">
        <div class="lightbox-close" onclick="closeLightbox()">&times;</div>
        <button class="lightbox-nav nav-prev" onclick="event.stopPropagation(); navigateLightbox(-1)">&#10094;</button>
        <button class="lightbox-nav nav-next" onclick="event.stopPropagation(); navigateLightbox(1)">&#10095;</button>
        <div id="lightbox-loading">Loading full size...</div>
        <img id="lightbox-img" src="" alt="Full View" onclick="event.stopPropagation()">
    </div>

    <script>
        // --- Global Tooltip Logic ---
        const tooltip = document.getElementById('global-tooltip');
        let activeTooltipTarget = null;
        // Only active if sidebar is present (Debug Mode)
        const isDebug = {{ 'true' if current_user and current_user.debug_mode else 'false' }};

        if (isDebug) {
            document.body.addEventListener('mouseover', (e) => {
                const wrapper = e.target.closest('.event-text-wrapper');
                if (wrapper) {
                    activeTooltipTarget = wrapper;
                    const rawData = wrapper.getAttribute('data-full-html');

                    // In debug mode, we just show the raw string (JSON) inside a pre tag
                    tooltip.innerHTML = '<pre style="margin:0; font-size: 0.75rem;">' + rawData + '</pre>';

                    tooltip.style.display = 'block';
                    tooltip.style.opacity = '1';
                }
            });

            document.body.addEventListener('mouseout', (e) => {
                if (activeTooltipTarget && (e.target.closest('.event-text-wrapper') === activeTooltipTarget)) {
                    if (!e.relatedTarget || !e.relatedTarget.closest('.event-text-wrapper')) {
                        tooltip.style.display = 'none';
                        tooltip.style.opacity = '0';
                        activeTooltipTarget = null;
                    }
                }
            });

            document.body.addEventListener('mousemove', (e) => {
                if (tooltip.style.display === 'block') {
                    const width = tooltip.offsetWidth;
                    const height = tooltip.offsetHeight;

                    let left = e.clientX - width - 15;
                    let top = e.clientY + 15;

                    if (left < 10) left = e.clientX + 15;
                    if (top + height > window.innerHeight) top = e.clientY - height - 10;

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                }
            });
        }

        // --- Lightbox Logic (Standard) ---
        let currentLightboxIndex = -1;
        let lightboxItems = [];

        function refreshLightboxItems() {
            const triggers = document.querySelectorAll('.lightbox-trigger');
            lightboxItems = Array.from(triggers).map(el => ({
                el: el,
                src: el.src,
                fullSrc: el.getAttribute('data-full-src')
            }));
        }

        function openLightbox(element) {
            refreshLightboxItems();
            currentLightboxIndex = lightboxItems.findIndex(item => item.el === element);
            if (currentLightboxIndex === -1) return;
            updateLightboxView();
            document.getElementById('lightbox').classList.add('active');
        }

        function updateLightboxView() {
            const item = lightboxItems[currentLightboxIndex];
            const img = document.getElementById('lightbox-img');
            const loader = document.getElementById('lightbox-loading');
            if (!item) return;
            img.style.display = 'none';
            loader.style.display = 'block';
            img.onload = () => {
                loader.style.display = 'none';
                img.style.display = 'block';
            };
            img.onerror = () => {
                img.src = item.src;
                loader.style.display = 'none';
                img.style.display = 'block';
            };
            img.src = item.fullSrc;
        }

        function navigateLightbox(dir) {
            const newIndex = currentLightboxIndex + dir;
            if (newIndex >= 0 && newIndex < lightboxItems.length) {
                currentLightboxIndex = newIndex;
                updateLightboxView();
            }
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            setTimeout(() => document.getElementById('lightbox-img').src = "", 300);
        }

        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('lightbox').classList.contains('active')) return;
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') navigateLightbox(-1);
            if (e.key === 'ArrowRight') navigateLightbox(1);
        });

        document.addEventListener('DOMContentLoaded', () => {
            window.parseAppleEmojis(document.body);
            window.renderLocalTimes(document.body);

            // If not debug, we don't attach SSE for the feed, but SSE is used for chat updates too.
            // We'll keep SSE active but only render feed items if container exists.
            const feedContainer = document.getElementById('event-feed-list');
            const evtSource = new EventSource("/api/events/stream");

            evtSource.onmessage = function (e) {
                const data = JSON.parse(e.data);
                const customEvent = new CustomEvent('tg:event', { detail: data });
                document.dispatchEvent(customEvent);

                if (data.type === 'read' || data.type === 'edited') return;

                if (feedContainer) {
                    const emptyMsg = feedContainer.querySelector('.empty-feed');
                    if (emptyMsg) emptyMsg.remove();

                    const item = document.createElement('div');
                    item.className = `event-item type-${data.type}`;

                    let iconHtml = '';
                    if (data.type === 'deleted') iconHtml = '<span class="event-type-icon">üóëÔ∏è</span>';
                    else if (data.type === 'action') iconHtml = '<span class="event-type-icon">‚ö°</span>';
                    else if (data.type === 'reaction_update') iconHtml = '<span class="event-type-icon">üëç</span>';

                    let chatLabel = data.chat_name;
                    if (data.topic_name) chatLabel = `${data.topic_name} - ${chatLabel}`;
                    const linkHref = data.link || '#';

                    // For debug mode tooltip, we use the raw JSON of data
                    const debugJson = isDebug ? JSON.stringify(data, null, 2)
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;") : "";

                    item.innerHTML = `
                        <div class="event-header">
                            ${iconHtml}
                            <a href="${linkHref}" class="event-chat-link" title="${chatLabel}">${chatLabel}</a>
                        </div>
                        <div class="event-text-wrapper" data-full-html="${debugJson}">
                            <div class="event-text">${data.text}</div>
                        </div>
                    `;

                    window.parseAppleEmojis(item);
                    feedContainer.insertBefore(item, feedContainer.firstChild);

                    const items = feedContainer.querySelectorAll('.event-item');
                    if (items.length > 10) items[items.length - 1].remove();
                }
            };
        });
    </script>
</body>

</html>
